<!DOCTYPE html>
<html lang="zh-CN">
<!-- ... (head and body structure up to script tag remains the same as previous correct version) ... -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>项目数据分析</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style_index.css') }}">
</head>
<body>
    <div class="top-bar">
        <div class="search-container">
            <input type="text" id="search-input" placeholder="搜索项目名称..." autocomplete="off">
            <button id="search-button">搜索</button>
            <div class="search-suggestions" id="search-suggestions-list"></div>
        </div>
    </div>

    <div class="app-shell">
        {% if error_message %}
            <div class="error-message">{{ error_message }}</div>
        {% endif %}
        <div class="main-container">
            <div class="charts-section-left">
                <div class="chart-wrapper">
                    <h3>规格评分 Top 10</h3>
                    <div class="chart-canvas-container">
                        <canvas id="topSpecScoreChart"></canvas>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <h3>评论评分 Top 10</h3>
                    <div class="chart-canvas-container">
                        <canvas id="topReviewScoreChart"></canvas>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <h3>价格区间分布</h3>
                    <div class="chart-canvas-container">
                        <canvas id="priceDistributionChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="ranking-section-right" id="ranking-section-right-id">
                    <h2 id="ranking-container-title">{{ ranking_title }}</h2>
                    <div class="ranking-content">
                        <form method="GET" action="{{ url_for('index') }}" class="sort-options" id="sort-form">
                            <label for="sort_by">排序依据:</label>
                            <select name="sort_by" id="sort_by">
                                <option value="spec_score" {% if current_sort_key == 'spec_score' %}selected{% endif %}>规格评分 (高到低)</option>
                                <option value="review_score" {% if current_sort_key == 'review_score' %}selected{% endif %}>评论评分 (高到低)</option>
                                <option value="price_asc" {% if current_sort_key == 'price_asc' %}selected{% endif %}>价格 (低到高)</option>
                                <option value="price_desc" {% if current_sort_key == 'price_desc' %}selected{% endif %}>价格 (高到低)</option>
                                <option value="name_asc" {% if current_sort_key == 'name_asc' %}selected{% endif %}>名称 (A-Z)</option>
                                <option value="name_desc" {% if current_sort_key == 'name_desc' %}selected{% endif %}>名称 (Z-A)</option>
                            </select>
                            <button type="submit">应用排序</button>
                        </form>
                        <p class="current-sort-info">当前排序: <strong id="current-sort-text">{{ current_sort_criteria }}</strong></p>

                        <div class="ranking-table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>排名</th>
                                        <th>项目名称</th>
                                        <th>价格 (元)</th>
                                        <th>规格分</th>
                                        <th>评论分</th>
                                    </tr>
                                </thead>
                                <tbody id="ranking-table-body">
                                    {% for item in ranked_items %}
                                    <tr>
                                        <td>{{ loop.index }}</td>
                                        <td>
                                            <div class="scrollable-item-name">
                                                <a href="{{ item.detail_url }}" class="item-name-link" title="{{ item.name if item.name else '-- 无标题 --' }}">
                                                    {{ item.name if item.name else '-- 无标题 --' }}
                                                </a>
                                            </div>
                                        </td>
                                        <td>¥{{ "%.2f"|format(item.price) if item.price is not none else '--' }}</td>
                                        <td>{{ "%.1f"|format(item.spec_score) if item.spec_score is not none else '--' }}</td>
                                        <td>{{ "%.1f"|format(item.review_score) if item.review_score is not none else '--' }}</td>
                                    </tr>
                                    {% else %}
                                     <tr><td colspan="5" style="text-align:center;">没有可显示的项目。</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div id="search-results-display-area"></div>
                    </div>
            </div>
        </div>
    </div>

    <script>
        Chart.defaults.font.family = 'Poppins', 'sans-serif';
        Chart.defaults.color = '#555';
        Chart.defaults.borderColor = '#ddd';
        Chart.defaults.maintainAspectRatio = false;

        const allItemsData = JSON.parse('{{ all_items_json | tojson | safe if all_items_json else "[]" }}');
        let currentRankedItemsForJS = JSON.parse('{{ all_items_json | tojson | safe if all_items_json else "[]" }}').map(item => ({
            ...item,
            detail_url: item.id ? "{{ url_for('item_detail', item_id='ITEM_ID_PLACEHOLDER') }}".replace('ITEM_ID_PLACEHOLDER', item.id) : '#',
            full_name: item.name || '-- 无标题 --'
        }));

        const topSpecChartData = JSON.parse('{{ top_spec_chart_data | tojson | safe if top_spec_chart_data else "{}" }}');
        const topReviewChartData = JSON.parse('{{ top_review_chart_data | tojson | safe if top_review_chart_data else "{}" }}');
        const priceDistributionChartData = JSON.parse('{{ price_distribution_chart_data | tojson | safe if price_distribution_chart_data else "{}" }}');

        let currentSortKeyGlobal = '{{ current_sort_key }}';
        let currentSortCriteriaGlobal = '{{ current_sort_criteria }}';
        const itemDetailUrlBase = "{{ url_for('item_detail', item_id='ITEM_ID_PLACEHOLDER') }}";
        let currentRankingTitleGlobal = "{{ ranking_title }}";


        let searchInput, searchButton, searchSuggestionsList,
            rankingTableBody, searchResultsDisplayArea, rankingSectionRightDiv,
            rankingTableWrapper, sortOptionsForm, sortBySelect, currentSortTextElement,
            rankingContainerTitleElement;
        let suggestionItems = [];
        let activeSuggestionIndex = -1;
        let searchContainer;
        let charts = {};

        function formatPrice(price) { return price != null ? `¥${parseFloat(price).toFixed(2)}` : '--'; }
        function formatScore(score) { return score != null ? parseFloat(score).toFixed(1) : '--'; }

        function renderRankingTable(itemsToRender, limit = 50) {
            if (!rankingTableBody) return;
            const itemsToShow = itemsToRender.slice(0, limit);

            rankingTableBody.classList.add('fade-out');
            setTimeout(() => {
                rankingTableBody.innerHTML = '';
                if (!itemsToShow || itemsToShow.length === 0) {
                    const row = rankingTableBody.insertRow();
                    const cell = row.insertCell(); cell.colSpan = 5;
                    cell.textContent = "没有可显示的项目。"; cell.style.textAlign = "center";
                } else {
                    itemsToShow.forEach((item, index) => {
                        const row = rankingTableBody.insertRow();
                        row.insertCell().textContent = index + 1;

                        const nameCell = row.insertCell();
                        const scrollableDiv = document.createElement('div');
                        scrollableDiv.classList.add('scrollable-item-name');
                        const link = document.createElement('a');
                        link.href = item.detail_url;
                        link.textContent = item.name || '-- 无标题 --';
                        link.classList.add('item-name-link');
                        link.setAttribute('title', item.full_name || item.name || '-- 无标题 --');
                        scrollableDiv.appendChild(link);
                        nameCell.appendChild(scrollableDiv);

                        row.insertCell().textContent = formatPrice(item.price);
                        row.insertCell().textContent = formatScore(item.spec_score);
                        row.insertCell().textContent = formatScore(item.review_score);
                    });
                }
                rankingTableBody.classList.remove('fade-out');
                rankingTableBody.classList.add('fade-in');
                setTimeout(() => rankingTableBody.classList.remove('fade-in'), 400);
            }, 150);
        }

        function displayFinalSearchResults(results, searchTerm) {
            if (!searchResultsDisplayArea || !rankingTableWrapper || !sortOptionsForm || !rankingSectionRightDiv || !rankingContainerTitleElement) return;
            searchResultsDisplayArea.innerHTML = '';
            const hasResults = results && results.length > 0;
            const isSearching = searchTerm && searchTerm.trim() !== "";

            rankingTableWrapper.style.display = isSearching ? 'none' : 'block';
            sortOptionsForm.style.display = isSearching ? 'none' : 'block';
            const currentSortInfoEl = document.querySelector('.current-sort-info');
            if(currentSortInfoEl) currentSortInfoEl.style.display = isSearching ? 'none' : 'block';

            if (isSearching) {
                rankingContainerTitleElement.textContent = "搜索结果";
                rankingSectionRightDiv.classList.add('search-active');
                if (hasResults) {
                    results.forEach((item, index) => {
                        const itemDiv = document.createElement('div');
                        itemDiv.classList.add('search-result-item');
                        const detailUrl = item.detail_url;
                        itemDiv.innerHTML = `
                            <h4><a href="${detailUrl}" class="item-name-link" title="${item.full_name || item.name || '-- 无标题 --'}">${item.name || '-- 无标题 --'}</a></h4>
                            <p class="price">价格: ${formatPrice(item.price)}</p>
                            <p class="scores">
                                <span class="label">规格分:</span> <span class="value">${formatScore(item.spec_score)}</span>
                                <span class="label">评论分:</span> <span class="value">${formatScore(item.review_score)}</span>
                            </p>
                        `;
                        itemDiv.addEventListener('click', (e) => { if (e.target.tagName !== 'A' && detailUrl !== '#') window.location.href = detailUrl; });
                        searchResultsDisplayArea.appendChild(itemDiv);
                        setTimeout(() => { itemDiv.style.opacity = '1'; itemDiv.style.transform = 'translateY(0)'; }, index * 50);
                    });
                } else {
                    searchResultsDisplayArea.innerHTML = '<p style="text-align:center; padding:20px;">未找到相关项目。</p>';
                }
                searchResultsDisplayArea.style.display = 'block';
            } else {
                rankingContainerTitleElement.textContent = currentRankingTitleGlobal;
                rankingSectionRightDiv.classList.remove('search-active');
                searchResultsDisplayArea.style.display = 'none';
                const initialRankedItemsFromPython = JSON.parse('{{ ranked_items | tojson | safe if ranked_items else "[]" }}');
                renderRankingTable(initialRankedItemsFromPython, 50);
            }
            if(searchSuggestionsList) searchSuggestionsList.style.display = 'none';
        }

        function handleSort() {
            if(!sortBySelect || !currentSortTextElement || !rankingContainerTitleElement || !currentRankedItemsForJS || !rankingSectionRightDiv) return;
            const newSortBy = sortBySelect.value;
            let sortedItems = [...currentRankedItemsForJS];
            let newSortCriteria = "";

            switch (newSortBy) {
                case 'spec_score': sortedItems.sort((a, b) => (b.spec_score || 0) - (a.spec_score || 0)); newSortCriteria = "规格评分"; break;
                 case 'review_score': sortedItems.sort((a, b) => (b.review_score || 0) - (a.review_score || 0)); newSortCriteria = "评论评分"; break;
                case 'price_asc': sortedItems.sort((a, b) => (a.price == null ? Infinity : a.price) - (b.price == null ? Infinity : b.price)); newSortCriteria = "价格 (低到高)"; break;
                case 'price_desc': sortedItems.sort((a, b) => (b.price == null ? -Infinity : b.price) - (a.price == null ? -Infinity : a.price)); newSortCriteria = "价格 (高到低)"; break;
                case 'name_asc': sortedItems.sort((a,b) => (a.name || "").toLowerCase().localeCompare((b.name || "").toLowerCase())); newSortCriteria = "名称 (A-Z)"; break;
                case 'name_desc': sortedItems.sort((a,b) => (b.name || "").toLowerCase().localeCompare((a.name || "").toLowerCase())); newSortCriteria = "名称 (Z-A)"; break;
                default: sortedItems.sort((a, b) => (b.spec_score || 0) - (a.spec_score || 0)); newSortCriteria = "规格评分"; break;
            }

            currentSortKeyGlobal = newSortBy;
            currentSortCriteriaGlobal = newSortCriteria;
            if(currentSortTextElement) currentSortTextElement.textContent = newSortCriteria;

            if(rankingContainerTitleElement) rankingContainerTitleElement.textContent = currentRankingTitleGlobal;
            if (rankingSectionRightDiv) rankingSectionRightDiv.classList.remove('search-active');
            if (searchResultsDisplayArea) { searchResultsDisplayArea.style.display = 'none'; searchResultsDisplayArea.innerHTML = ''; }
            if (rankingTableWrapper) rankingTableWrapper.style.display = 'block';
            if (sortOptionsForm) sortOptionsForm.style.display = 'block';
            const currentSortInfoEl = document.querySelector('.current-sort-info');
            if (currentSortInfoEl) currentSortInfoEl.style.display = 'block';

            renderRankingTable(sortedItems, 50);
        }

        function createChart(canvasId, chartType, chartLabel, labelsData, data, backgroundColor, borderColor, yAxisLabel = '', optionsOverrides = {}) {
            const canvasElement = document.getElementById(canvasId);
            if (!canvasElement) { console.error(`Canvas ${canvasId} not found.`); return; }
            const ctx = canvasElement.getContext('2d');

            if (charts[canvasId]) { charts[canvasId].destroy(); }

            if (!labelsData || labelsData.length === 0 || !data || data.length === 0) {
                ctx.clearRect(0, 0, canvasElement.width, canvasElement.height);
                ctx.font = "14px 'Poppins', sans-serif"; ctx.textAlign = 'center'; ctx.fillStyle = '#888';
                ctx.fillText('无可用数据', canvasElement.width / 2, canvasElement.height / 2);
                return;
            }

            const defaultOptions = {
                responsive: true,
                scales: {
                    y: { beginAtZero: true, title: { display: !!yAxisLabel, text: yAxisLabel, font: {size: 12} } },
                    x: { ticks: { autoSkip: chartType === 'bar' && labelsData.length > 15 ? true : false, maxRotation: labelsData.length > 10 ? 75 : 45, minRotation: 0, font: {size: 8} } }
                },
                plugins: {
                    legend: { display: chartType !== 'doughnut' && chartType !== 'pie' && data.length > 1, labels: { font: { size: 10 } } },
                    tooltip: { titleFont: {size: 12}, bodyFont: {size: 11} }
                }
            };

            charts[canvasId] = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: labelsData,
                    datasets: [{
                        label: chartLabel,
                        data: data,
                        backgroundColor: backgroundColor,
                        borderColor: borderColor,
                        borderWidth: 1,
                        borderRadius: chartType === 'bar' ? 4 : undefined,
                    }]
                },
                options: {...defaultOptions, ...optionsOverrides}
            });
        }

        function initializeCharts() {
             const specScoreColor = { background: 'rgba(54, 162, 235, 0.6)', border: 'rgba(54, 162, 235, 1)' };
            const reviewScoreColor = { background: 'rgba(75, 192, 192, 0.6)', border: 'rgba(75, 192, 192, 1)' };
            const priceDistColor = { background: 'rgba(255, 159, 64, 0.6)', border: 'rgba(255, 159, 64, 1)' };

            createChart('topSpecScoreChart', 'bar', '规格评分', topSpecChartData.labels, topSpecChartData.scores, specScoreColor.background, specScoreColor.border, '评分');
            createChart('topReviewScoreChart', 'bar', '评论评分', topReviewChartData.labels, topReviewChartData.scores, reviewScoreColor.background, reviewScoreColor.border, '评分');
            createChart('priceDistributionChart', 'bar', '商品数量', priceDistributionChartData.labels, priceDistributionChartData.counts, priceDistColor.background, priceDistColor.border, '数量',
                {scales: {x: {ticks: {font: {size: priceDistributionChartData.labels.length > 20 ? 7 : 8}}}}}
            );
        }

        document.addEventListener('DOMContentLoaded', () => {
            searchInput = document.getElementById('search-input');
            searchButton = document.getElementById('search-button');
            searchSuggestionsList = document.getElementById('search-suggestions-list');
            rankingTableBody = document.getElementById('ranking-table-body');
            searchResultsDisplayArea = document.getElementById('search-results-display-area');
            rankingSectionRightDiv = document.getElementById('ranking-section-right-id');
            rankingContainerTitleElement = document.getElementById('ranking-container-title');
            rankingTableWrapper = document.querySelector('.ranking-table-wrapper');
            sortOptionsForm = document.getElementById('sort-form');
            sortBySelect = document.getElementById('sort_by');
            currentSortTextElement = document.getElementById('current-sort-text');
            searchContainer = document.querySelector('.search-container');


            if (!allItemsData || allItemsData.length === 0) {
                console.warn("allItemsData 为空或未正确加载。");
                 const initialRankedItemsFromPython = JSON.parse('{{ ranked_items | tojson | safe if ranked_items else "[]" }}');
                 renderRankingTable(initialRankedItemsFromPython, 50);
            } else {
                const initialRankedItemsFromPython = JSON.parse('{{ ranked_items | tojson | safe if ranked_items else "[]" }}');
                renderRankingTable(initialRankedItemsFromPython, 50);
            }

            initializeCharts();

            if (searchInput) {
                searchInput.addEventListener('input', () => updateSearchSuggestions(searchInput.value.toLowerCase().trim()));
                searchInput.addEventListener('keydown', (e) => {
                     if (!searchSuggestionsList || searchSuggestionsList.style.display !== 'block' || suggestionItems.length === 0) {
                         if (e.key === 'Enter') { e.preventDefault(); executeSearch(); } return;
                    }
                    if (e.key === 'ArrowDown') { e.preventDefault(); activeSuggestionIndex = (activeSuggestionIndex + 1) % suggestionItems.length; updateSuggestionHighlight(); }
                    else if (e.key === 'ArrowUp') { e.preventDefault(); activeSuggestionIndex = (activeSuggestionIndex - 1 + suggestionItems.length) % suggestionItems.length; updateSuggestionHighlight(); }
                    else if (e.key === 'Enter') {
                        e.preventDefault();
                        if (activeSuggestionIndex > -1 && suggestionItems[activeSuggestionIndex]) {
                            suggestionItems[activeSuggestionIndex].click();
                        } else { executeSearch(); }
                    } else if (e.key === 'Escape') { if(searchSuggestionsList) searchSuggestionsList.style.display = 'none'; }
                });
            }
            if (searchButton) searchButton.addEventListener('click', executeSearch);
            if (sortOptionsForm) {
                sortOptionsForm.addEventListener('submit', function(event) {
                    event.preventDefault(); handleSort();
                });
            }
            if (searchContainer && searchSuggestionsList) {
                 document.addEventListener('click', function(event) {
                    if (searchContainer && !searchContainer.contains(event.target)) {
                        if(searchSuggestionsList) searchSuggestionsList.style.display = 'none';
                    }
                });
            }
            const urlParams = new URLSearchParams(window.location.search);
            const sortByParam = urlParams.get('sort_by');
            if (sortByParam && sortBySelect) sortBySelect.value = sortByParam;

            function updateSearchSuggestions(searchTerm) {
                if (!searchSuggestionsList) return;
                searchSuggestionsList.innerHTML = '';
                activeSuggestionIndex = -1;
                suggestionItems = [];
                if (searchTerm === '' || !allItemsData || allItemsData.length === 0) {
                    searchSuggestionsList.style.display = 'none';
                    return;
                }
                const filtered = allItemsData.filter(item =>
                    item.name && item.name.toLowerCase().includes(searchTerm)
                ).slice(0, 7);
                if (filtered.length > 0) {
                    const ul = document.createElement('ul');
                    filtered.forEach((item) => {
                        const li = document.createElement('li');
                        li.textContent = item.name;
                        li.dataset.itemId = item.id;
                        li.setAttribute('title', item.full_name || item.name || '-- 无标题 --');
                        li.addEventListener('click', () => {
                            if(searchInput) searchInput.value = item.name;
                            if(searchSuggestionsList) searchSuggestionsList.style.display = 'none';
                            const detailUrl = item.id ? (itemDetailUrlBase.replace('ITEM_ID_PLACEHOLDER', item.id)) : '#';
                            if (detailUrl !== '#') window.location.href = detailUrl;
                        });
                        ul.appendChild(li);
                        suggestionItems.push(li);
                    });
                    searchSuggestionsList.appendChild(ul);
                    searchSuggestionsList.style.display = 'block';
                } else {
                    searchSuggestionsList.style.display = 'none';
                }
            }

            function executeSearch() {
                if (!searchInput) return;
                const searchTerm = searchInput.value.toLowerCase().trim();
                if(searchSuggestionsList) searchSuggestionsList.style.display = 'none';
                if (searchTerm === '') {
                    displayFinalSearchResults(null, ""); return;
                }
                if (!allItemsData || allItemsData.length === 0) {
                    displayFinalSearchResults([], searchTerm); return;
                }
                const finalResults = allItemsData.filter(item =>
                    item.name && item.name.toLowerCase().includes(searchTerm)
                );
                displayFinalSearchResults(finalResults, searchTerm);
            }

            function updateSuggestionHighlight() {
                suggestionItems.forEach((item, index) => {
                    item.classList.toggle('active', index === activeSuggestionIndex);
                });
            }
        });
    </script>
</body>
</html>